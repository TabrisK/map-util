<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="cache-control" content="max-age=0"/>
    <meta http-equiv="cache-control" content="no-cache"/>
    <meta http-equiv="expires" content="0"/>
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT"/>
    <meta http-equiv="pragma" content="no-cache"/>


    <meta charset="UTF-8">
    <link href="./favicon.ico" rel="icon" type="image/x-icon"/>
    <title>map-util</title>
    <style type="text/css">
        ul, li {
            list-style: none;
            margin: 0;
            padding: 0;
            float: left;
        }

        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0px;
            padding: 0px;
            font-family: "微软雅黑";
        }

        #container {
            height: 500px;
            width: 100%;
        }

        #r-result {
            width: 100%;
        }
    </style>
</head>
<body>
<div id="container"></div>
<input id="file" type="file">
<p>总长：<b id="sum"></b>米</p>
<p>时长：<b id="duration"></b></p>
<p>起始：<b id="from"></b></p>
<p>截止：<b id="to"></b></p>
<script src="./underscore.js"></script>
<script src="https://api.map.baidu.com/api?v=2.0&ak=nLcg543nSxxibj5V0dwU02Dl&s=1"></script>
<script src="./main.js"></script>
<script>
    var map = new BMap.Map("container");          // 创建地图实例
    var convertMax = 10;

    var point = new BMap.Point(121.48, 31.22);
    var fileInput = document.getElementById("file");
    map.centerAndZoom(point, 15);
    map.enableScrollWheelZoom();

    fileInput.onchange = function (e) {
        startRead(fileInput);
    };
    function draw(points) {
        debugger;
        map.clearOverlays();
        var pointIs = points.map(function (p) {
            return new BMap.Point(p[0], p[1]);
        });
        convert(pointIs, function (ps) {
            map.addOverlay(new BMap.Polyline(ps));
            map.setViewport(ps);
            document.getElementById("sum").innerHTML = getDistance(ps).toFixed(3);
            if(points[0][2] && points[points.length - 1][2]){
                document.getElementById("from").innerHTML = points[0][2];
                document.getElementById("to").innerHTML = points[points.length - 1][2];
                var dTime =
                        new Date(points[points.length - 1][2]).getTime() -
                        new Date(points[0][2]).getTime() ;
                document.getElementById("duration").innerHTML = getDuration(dTime);
            }
        }, 0);
    }

    function getDistance(ps) {
        var sum = 0;
        for (var index = 0; index < ps.length - 1; index++) {
            sum += map.getDistance(ps[index],
                    ps[index + 1]);
        }
        return sum;
    }


    function convert(ps, fn, startI) {
        var convertor = new BMap.Convertor();
        if(!ps[startI]) fn([]);
        if(ps[startI + convertMax - 1]){//到此100个存在，继续向下求
            convertor.translate(ps.slice(startI, startI + convertMax), 1, 5, function (data) {
                if (data.status === 0) {
                    convert(ps, function(subPs){
                        return fn(data.points.concat(subPs));
                    }, startI + convertMax);
                }
            });
        }else{//第100个已不存在，为最后一批点
            convertor.translate(ps.slice(startI, ps.length - 1), 1, 5, function (data) {
                if (data.status === 0) {
                    fn(data.points);
                }
            });
        }
    }

    function getDuration(input, lang){
        if(!input)return input;
        var out = "";
        var min,hours,days;
        var tStr = {
            d: lang == "en"?"day":"天",
            h: lang == "en"?"h":"小时",
            m: lang == "en"?"min":"分钟"
        };
        input = Math.ceil(input/60);
        min = input % 60;
        out += min + tStr.m;
        if(input - min > 0){
            hours = (input - min) % (60*24) / 60;
            out = hours + tStr.h + out;
            if(input - min - hours*60 > 0){
                days = (input - min - hours*60) / (24*60);
                out = days + tStr.d + out;
            }
        }

        return out;
    }
</script>
</body>
</h